#!/usr/bin/env python3
"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –æ—Ç–≤–µ—Ç–æ–º.
–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å.
"""

from modules.check_current_date import get_current_datetime_info, format_date_warning

class AutoDateChecker:
    """
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞—Ç—É –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.
    """

    def __init__(self):
        self.date_info = get_current_datetime_info()
        self.current_year = self.date_info.get('year', 2024)

    def should_warn_about_date(self, user_query):
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ –¥–∞—Ç–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
        """
        if self.current_year > 2024:
            # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã
            time_sensitive_keywords = [
                '—Å–µ–≥–æ–¥–Ω—è', '—Å–µ–π—á–∞—Å', '—Ç–µ–∫—É—â', '–∏–¥–µ—Ç', 'live', '–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å',
                '—Ç—É—Ä–Ω–∏—Ä', '–º–∞—Ç—á', '—Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ', '—á–µ–º–ø–∏–æ–Ω–∞—Ç', '—Å–æ–±—ã—Ç–∏–µ',
                '–ø–æ–≥–æ–¥–∞', '—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ', '–≥—Ä–∞—Ñ–∏–∫', '—Ä–∞–±–æ—Ç–∞–µ—Ç', '–æ—Ç–∫—Ä—ã—Ç',
                '–Ω–æ–≤–æ—Å—Ç–∏', '–∞–∫—Ç—É–∞–ª—å–Ω', '–ø–æ—Å–ª–µ–¥–Ω', '—Å–≤–µ–∂', '–Ω–µ–¥–∞–≤–Ω',
                '–≤—á–µ—Ä–∞', '–∑–∞–≤—Ç—Ä–∞', '–Ω–µ–¥–µ–ª—è', '–º–µ—Å—è—Ü', '–Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ',
                '–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ', '–≤ —ç—Ç–æ–º –≥–æ–¥—É', '—Å–µ–π—á–∞—Å –≤—Ä–µ–º—è', '–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å',
                '—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏', '–¥–∞—Ç–∞', '—á–∏—Å–ª–æ', '–¥–µ–Ω—å', '–∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è'
            ]

            query_lower = user_query.lower()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
            for keyword in time_sensitive_keywords:
                if keyword in query_lower:
                    return True

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –æ —Ç–µ–∫—É—â–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö
            if any(word in query_lower for word in ['—á—Ç–æ', '–∫–∞–∫', '–≥–¥–µ', '–∫–æ–≥–¥–∞', '–ø–æ—á–µ–º—É']):
                if any(context in query_lower for context in ['–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç', '—Å–ª—É—á–∞–µ—Ç—Å—è', '–∏–¥—ë—Ç', '–ø—Ä–æ—Ö–æ–¥–∏—Ç']):
                    return True

        return False

    def get_date_warning_message(self, user_query):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –¥–∞—Ç–µ.
        """
        warning = format_date_warning()

        specific_advice = f"""

üéØ **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –≠–¢–û–ì–û –ó–ê–ü–†–û–°–ê:**

üìù **–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** "{user_query}"

üîç **–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞:**
‚Ä¢ –ó–∞–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏—Ö/–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
‚Ä¢ –°–∏—Å—Ç–µ–º–Ω–∞—è –¥–∞—Ç–∞: {self.current_year} –≥–æ–¥ (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞)
‚Ä¢ –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞: 2024 –≥–æ–¥

üí° **–ö–∞–∫ –æ—Ç–≤–µ—Ç–∏—Ç—å:**
1. –ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –¥–∞—Ç–µ
2. –£—Ç–æ—á–Ω–∏—Ç–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "–°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç {self.current_year} –≥–æ–¥. –í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —Å–æ–±—ã—Ç–∏—è —ç—Ç–æ–≥–æ –≥–æ–¥–∞ –∏–ª–∏ 2024 –≥–æ–¥–∞?"
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–æ—á–Ω–∏—Ç –¥–∞—Ç—É, –∏—â–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
4. –ï—Å–ª–∏ –Ω–µ—Ç - –¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç —Å –æ–≥–æ–≤–æ—Ä–∫–æ–π –æ –≤–æ–∑–º–æ–∂–Ω–æ–π –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞—Ç—ã

‚ö†Ô∏è **–ù–ï –î–ï–õ–ê–ô–¢–ï:**
‚Ä¢ –ù–µ –¥–∞–≤–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –æ "—Ç–µ–∫—É—â–∏—Ö" —Å–æ–±—ã—Ç–∏—è—Ö –±–µ–∑ –æ–≥–æ–≤–æ—Ä–∫–∏
‚Ä¢ –ù–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π—Ç–µ, —á—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–∞—è –¥–∞—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
‚Ä¢ –ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –≥–æ–¥–∞—Ö
"""

        return warning + specific_advice

    def process_response(self, user_query, planned_response):
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–π –æ—Ç–≤–µ—Ç —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—ã.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
        """
        if self.should_warn_about_date(user_query):
            return {
                'needs_date_warning': True,
                'warning_message': self.get_date_warning_message(user_query),
                'original_response': planned_response,
                'suggested_response': f"{self.get_date_warning_message(user_query)}\n\nüìã **–ü–õ–ê–ù–ò–†–£–ï–ú–´–ô –û–¢–í–ï–¢:**\n{planned_response}"
            }
        else:
            return {
                'needs_date_warning': False,
                'original_response': planned_response,
                'suggested_response': planned_response
            }

def get_enhanced_system_prompt():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ª—É—á—à–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –¥–∞—Ç—ã.
    """
    checker = AutoDateChecker()

    date_instruction = f"""

{'='*80}
üö® **–í–ê–ñ–ù–ï–ô–®–ï–ï –ü–†–ê–í–ò–õ–û - –ü–†–û–í–ï–†–ö–ê –î–ê–¢–´ (–î–û–ë–ê–í–õ–ï–ù–û 16.02.2026):**

üìÖ **–¢–ï–ö–£–©–ê–Ø –°–ò–°–¢–ï–ú–ù–ê–Ø –î–ê–¢–ê: {checker.current_year} –≥–æ–¥**

**–ê–ë–°–û–õ–Æ–¢–ù–û –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:**
1. **–ü–ï–†–í–´–ô –®–ê–ì –í –õ–Æ–ë–û–ú –î–ò–ê–õ–û–ì–ï:** –í—ã–∑–æ–≤–∏—Ç–µ get_current_time()
2. **–°–†–ê–í–ù–ò–¢–ï –ì–û–î:** –ï—Å–ª–∏ –≥–æ–¥ > 2024, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ë–£–î–£–©–ï–ï –≤—Ä–µ–º—è
3. **–î–õ–Ø –ó–ê–ü–†–û–°–û–í –û –¢–ï–ö–£–©–ò–• –°–û–ë–´–¢–ò–Ø–•:**
   - –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π—Ç–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –¥–∞—Ç–µ
   - –ü—Ä–∏–º–µ—Ä: "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç {checker.current_year} –≥–æ–¥..."
   - –£—Ç–æ—á–Ω—è–π—Ç–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –≥–æ–¥
4. **–ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê, –¢–†–ï–ë–£–Æ–©–ò–ï –ü–†–û–í–ï–†–ö–ò:**
   ‚Ä¢ —Å–µ–≥–æ–¥–Ω—è, —Å–µ–π—á–∞—Å, —Ç–µ–∫—É—â–∏–π, –∏–¥–µ—Ç, live
   ‚Ä¢ —Ç—É—Ä–Ω–∏—Ä, –º–∞—Ç—á, –ø–æ–≥–æ–¥–∞, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
   ‚Ä¢ –Ω–æ–≤–æ—Å—Ç–∏, —Å–æ–±—ã—Ç–∏—è, –∞–∫—Ç—É–∞–ª—å–Ω—ã–π
   ‚Ä¢ –≤—á–µ—Ä–∞, –∑–∞–≤—Ç—Ä–∞, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü

**–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê:**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫–∏–µ —Ç—É—Ä–Ω–∏—Ä—ã –ø–æ CS2 –∏–¥—É—Ç —Å–µ–π—á–∞—Å?"
–í—ã:
1. get_current_time() ‚Üí 2026-02-16
2. "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 2026 –≥–æ–¥. –ï—Å–ª–∏ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —Ç—É—Ä–Ω–∏—Ä—ã 2024 –≥–æ–¥–∞..."
3. –î–∞–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–Ω–∏—Ä–∞—Ö 2026 –≥–æ–¥–∞ —Å –æ–≥–æ–≤–æ—Ä–∫–æ–π

**–ù–ê–ö–ê–ó–ê–ù–ò–ï –ó–ê –ù–ê–†–£–®–ï–ù–ò–ï:**
–ï—Å–ª–∏ –≤—ã –æ—Ç–≤–µ—Ç–∏—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ —Ç–µ–∫—É—â–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—ã –ø—Ä–∏ year > 2024,
–≤–∞—à –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –ù–ï–ö–û–†–†–ï–ö–¢–ù–´–ú –∏ –í–í–ï–î–ï–¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ!
{'='*80}
"""

    return date_instruction

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
auto_checker = AutoDateChecker()

if __name__ == "__main__":
    print("=== –¢–ï–°–¢ –ê–í–¢–û–ü–†–û–í–ï–†–ö–ò –î–ê–¢–´ ===")

    test_queries = [
        "–ö–∞–∫–∏–µ —Ç—É—Ä–Ω–∏—Ä—ã –ø–æ CS2 –∏–¥—É—Ç —Å–µ–π—á–∞—Å?",
        "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è –≤ –ò—Ä–∫—É—Ç—Å–∫–µ?",
        "–†–∞—Å—Å–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é –í—Ç–æ—Ä–æ–π –º–∏—Ä–æ–≤–æ–π –≤–æ–π–Ω—ã",
        "–ö–∞–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–±—É—Å–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?",
        "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å –≤ –º–∏—Ä–µ?",
        "–ö–∞–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é?"
    ]

    for query in test_queries:
        print(f"\n{'='*60}")
        print(f"–ó–∞–ø—Ä–æ—Å: {query}")

        test_response = "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—ã."
        result = auto_checker.process_response(query, test_response)

        if result['needs_date_warning']:
            print("‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢–°–Ø –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –û –î–ê–¢–ï!")
            print(f"–î–ª–∏–Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: {len(result['warning_message'])} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"–ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤:\n{result['warning_message'][:200]}...")
        else:
            print("‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")

    print("\n" + "="*60)
    print("–£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø:")
    print(get_enhanced_system_prompt())